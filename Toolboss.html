<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venten ToolBoss</title>
    <!-- Favicon: use site logo as fallback to avoid 404 on favicon requests -->
    <link rel="icon" href="https://www.venten.ee/static/version1769687684/frontend/Zaproo/venten/et_EE/images/logo.png" type="image/png">
    <style>
        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #0a0a0a;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --text-tertiary: #666;
            --border-color: #404040;
            --accent-green: #00ff41;
            --accent-red: #ff4444;
            --accent-blue: #0088ff;
            --input-bg: #2a2a2a;
        }

        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8e8;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #d0d0d0;
            --accent-green: #00aa00;
            --accent-red: #cc0000;
            --accent-blue: #0066cc;
            --input-bg: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background: var(--bg-primary);
            padding: 15px;
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .header {
            background: linear-gradient(to right, var(--bg-primary), var(--bg-secondary));
            color: var(--accent-green);
            padding: 15px 25px;
            border-bottom: 3px solid var(--accent-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            height: 50px;
            width: auto;
            max-width: 150px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 1.6em;
            letter-spacing: 2px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Theme Toggle Switch */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            background: var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid var(--border-color);
        }

        .toggle-checkbox:checked + .toggle-label {
            background: var(--accent-green);
        }

        .toggle-label::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bg-secondary);
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-checkbox:checked + .toggle-label::before {
            left: 28px;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: opacity 0.3s;
        }

        .toggle-icon.sun {
            opacity: 0;
        }

        .toggle-checkbox:checked + .toggle-label ~ .toggle-icon.sun {
            opacity: 1;
        }

        .toggle-checkbox:checked + .toggle-label ~ .toggle-icon.moon {
            opacity: 0;
        }

        .content {
            display: grid;
            grid-template-columns: 350px 350px 1fr;
            gap: 15px;
            padding: 15px;
        }

        .section {
            background: var(--bg-tertiary);
            padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        body.light-mode .section {
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: var(--accent-green);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: var(--text-secondary);
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.9em;
            font-family: 'Consolas', monospace;
            transition: all 0.2s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.3);
        }

        body.light-mode .input-group input:focus,
        body.light-mode .input-group select:focus {
            box-shadow: 0 0 5px rgba(0, 170, 0, 0.3);
        }

        .tool-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .tool-column {
            background: var(--bg-primary);
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .tool-column h3 {
            color: var(--accent-red);
            margin-bottom: 10px;
            text-align: center;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .new-tool h3 {
            color: var(--accent-green);
        }

        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: 2px solid var(--accent-green);
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Consolas', monospace;
        }

        .calculate-btn:hover {
            background: var(--bg-primary);
            color: var(--accent-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        }

        body.light-mode .calculate-btn {
            background: var(--accent-green);
            color: #ffffff;
        }

        body.light-mode .calculate-btn:hover {
            background: var(--accent-green);
            color: #ffffff;
            box-shadow: 0 0 15px rgba(0, 170, 0, 0.3);
        }

        .results {
            grid-column: 1 / -1;
            display: none;
        }

        .results.show {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric-card {
            background: var(--bg-primary);
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-green);
        }

        .metric-card.positive {
            border-left-color: var(--accent-green);
            background: var(--bg-secondary);
        }

        body.light-mode .metric-card.positive {
            background: #e8f5e9;
        }

        .metric-card.negative {
            border-left-color: var(--accent-red);
            background: var(--bg-secondary);
        }

        body.light-mode .metric-card.negative {
            background: #ffebee;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--accent-green);
            margin: 6px 0;
            font-family: 'Consolas', monospace;
        }

        .metric-card.negative .metric-value {
            color: var(--accent-red);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: var(--bg-primary);
            padding: 15px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }

        .chart-container h3 {
            color: var(--accent-green);
            margin-bottom: 12px;
            text-align: center;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .comparison-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
        }

        .comparison-item {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--border-color);
        }

        .comparison-item.current {
            border-left-color: var(--accent-red);
        }

        .comparison-item.new {
            border-left-color: var(--accent-green);
        }

        .comparison-value {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--accent-green);
            font-family: 'Consolas', monospace;
        }

        .comparison-item.current .comparison-value {
            color: var(--accent-red);
        }

        .comparison-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary {
            background: var(--bg-primary);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-green);
        }

        .summary h3 {
            color: var(--accent-green);
            margin-bottom: 10px;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--accent-green);
            margin-top: 5px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }

        @media (max-width: 1400px) {
            .content {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }

            .tool-columns {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .efficiency-bar-wrapper {
            margin-bottom: 12px;
        }

        .efficiency-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.75em;
            text-transform: uppercase;
        }

        .efficiency-bar-bg {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            overflow: hidden;
            height: 30px;
            position: relative;
        }

        .efficiency-bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
            transition: width 1s ease;
            font-size: 0.8em;
        }

        .efficiency-bar.current-eff {
            background: var(--accent-red);
            width: 100%;
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }

        .efficiency-bar.new-eff {
            background: var(--accent-green);
            width: 100%;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 6px 0;
            font-size: 0.9em;
            color: var(--text-primary);
            justify-content: space-between;
        }

        .pie-legend-item .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            flex: 0 0 auto;
        }

        .pie-legend-item .legend-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1 1 auto;
        }

        .pie-legend-item .legend-label {
            font-weight: 700;
            color: var(--text-primary);
            text-transform: none;
        }

        .pie-legend-item .legend-pct {
            font-weight: 700;
            color: var(--accent-green);
            min-width: 45px;
            text-align: right;
        }

        .pie-legend {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-top: 8px;
        }

        .pie-center-label {
            position: relative;
            width: 100%;
            text-align: center;
            margin-top: 6px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Modal styles: keep dialog hidden by default to avoid layout shifts */
        .dialog-container { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 9999; }
        .dialog-container.show { display: flex; }
        .dialog-content { background: var(--bg-secondary); padding: 18px; border-radius: 6px; border: 1px solid var(--border-color); max-width: 520px; width: calc(100% - 40px); box-shadow: 0 6px 30px rgba(0,0,0,0.6); }
        .btn-base { padding: 10px; border-radius: 4px; cursor: pointer; }
        .btn-close { background: #333; color: #fff; border: 1px solid #444; }
        .btn-send { background: #0088ff; color: #fff; border: 1px solid #0077dd; }
        /* Upload image styles */
        .uploaded-image-container { display:flex; flex-direction:column; gap:8px; align-items:center; }
        .uploaded-image { max-width: 100%; max-height: 160px; object-fit: contain; border: 1px solid var(--border-color); border-radius: 4px; }
        .upload-btn { padding: 8px 10px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; }
        .upload-btn:hover { background: var(--accent-green); color: #000; }
        /* Footer improvements */
        .footer-wrapper { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 18px; border-top:1px solid var(--border-color); color:var(--text-secondary); }
        .footer-credit a, .footer-developer a { color: var(--accent-blue); text-decoration: none; }
        .footer-developer a:hover { text-decoration: underline; }
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .content { padding: 10px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left">
            <img src="https://www.venten.ee/static/version1769687684/frontend/Zaproo/venten/et_EE/images/logo.png"
                 alt="Venten Logo"
                 class="header-logo"
                 title="Venten O√ú">
            <div class="header-title">
                <h1>‚öô VENTEN TOOLBOSS v2.0</h1>
                <p>T√ñ√ñRIISTADE V√ïRDLUS | KULUDE ANAL√ú√úS | OPTIMISEERIMINE</p>
            </div>
        </div>
        <div class="header-right">
            <div style="text-align: right; font-size: 0.8em; color: var(--text-secondary);">
                <div>SYS: ONLINE</div>
                <div id="currentDateTime"></div>
            </div>
            <div class="theme-toggle">
                <span class="toggle-icon moon">üåô</span>
                <input type="checkbox" id="themeToggle" class="toggle-checkbox">
                <label for="themeToggle" class="toggle-label"></label>
                <span class="toggle-icon sun">‚òÄÔ∏è</span>
            </div>
            <!-- Language selector -->
            <div style="display:flex; align-items:center; gap:8px;">
                <label for="langSelect" style="font-size:0.85em; color:var(--text-secondary);">Lang</label>
                <select id="langSelect" aria-label="Language" style="padding:6px; background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color);">
                    <option value="et">ET</option>
                    <option value="en">EN</option>
                </select>
            </div>
        </div>
    </div>

    <div class="content">
        <!-- Project Information -->
        <div class="section">
            <h2>[ PROJEKTI INFO ]</h2>
            <div class="input-group">
                <label for="client">Klient</label>
                <input type="text" id="client" placeholder="N√§it: Laast Vegas O√º">
            </div>
            <div class="input-group">
                <label for="clientRep">Kliendi esindaja</label>
                <input type="text" id="clientRep" placeholder="N√§it: T√µnu Tolerantsimurdja">
            </div>
            <div class="input-group">
                <label for="salesRep">M√º√ºgiesindaja</label>
                <input type="text" id="salesRep" placeholder="N√§it: Toomas Tammer">
            </div>


            <div class="input-group">
                <label for="testDate">Kuup√§ev</label>
                <input type="date" id="testDate">
            </div>
            <div class="input-group">
                <label for="machine">Masin</label>
                <input type="text" id="machine" placeholder="N√§it: Freespink">
            </div>
            <div class="input-group">
                <label for="application">Aplikatsioon</label>
                <select id="application">
                    <option value="Freesimine">Freesimine</option>
                    <option value="Treepink">Treepink</option>
                    <option value="Puurimine">Puurimine</option>
                    <option value="Lihvimine">Lihvimine</option>
                </select>
            </div>
            <div class="input-group">
                <label for="material">Materjal</label>
                <input type="text" id="material" placeholder="N√§it: Alumiinium AW7075">
            </div>
            <div class="input-group">
                <label for="coolant">L√µikevedelik</label>
                <select id="coolant" onchange="calculateToolLifeEstimate('current'); calculateToolLifeEstimate('new');">
                    <option value="emulsion">Emulsioon</option>
                    <option value="oil">√ïli</option>
                    <option value="synthetic">S√ºnteetiline</option>
                    <option value="semi-synthetic">Pools√ºnteetiline</option>
                    <option value="dry">Kuiv (ilma)</option>
                    <option value="mql">MQL (minimaalne)</option>
                    <option value="air">√ïhk</option>
                </select>
            </div>
            <div class="input-group">
                <label for="batchSize">Detailide kogus (partii)</label>
                <input type="number" id="batchSize" value="3" min="1">
            </div>
            <div class="input-group">
                <label for="yearlyQuantity">Detailide kogus (aastas)</label>
                <input type="number" id="yearlyQuantity" value="120" min="1">
            </div>
        </div>

        <!-- Machine Parameters -->
        <div class="section">
            <h2>[ MASINA PARAM ]</h2>
            <div class="input-group">
                <label for="machineRate">Masina hind (‚Ç¨/h)</label>
                <input type="number" id="machineRate" value="90" min="0" step="1">
            </div>
            <div class="input-group">
                <label for="toolChangeTime">T√∂√∂riista vahetamise aeg (sekundit)</label>
                <input type="text" id="toolChangeTime" value="10" style="background: var(--input-bg); color: var(--text-primary);" oninput="evaluateMathExpression(this)">
            </div>
            <div class="input-group">
                <label for="workHours">T√∂√∂tunnid aastas</label>
                <input type="number" id="workHours" value="1500" min="1">
            </div>

            <!-- Machine Label Photo Upload -->
            <div class="upload-section" id="uploadSection">
                <label class="upload-label">üì∏ Masina etikett (foto)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="machinePhoto" accept="image/*" onchange="handlePhotoUpload(event)">
                    <button class="upload-btn" onclick="document.getElementById('machinePhoto').click();">
                        Laadi pilt
                    </button>
                </div>
                <div class="upload-info">
                    PNG, JPG, GIF (max 5MB) - Masina sildilt pilt
                </div>
                <div class="uploaded-image-container" id="imageContainer">
                    <div class="photo-placeholder">√úkski pilt pole √ºles laaditud</div>
                </div>
            </div>
        </div>

        <!-- Tool Comparison -->
        <div class="section" style="grid-column: 1 / -1;">
            <h2>[ T√ñ√ñRIISTADE V√ïRDLUS ]</h2>
            <div class="tool-columns">
                <!-- Current Tool -->
                <div class="tool-column current-tool">
                    <h3>‚ñº HETKEL KASUTUSEL</h3>
                    <div class="input-group">
                        <label for="currentToolName">T√∂√∂riista nimi</label>
                        <input type="text" id="currentToolName" placeholder="N√§it: noName Hiinakas">
                    </div>
                    <div class="input-group">
                        <label for="currentToolPrice">T√∂√∂riista hind (‚Ç¨)</label>
                        <input type="number" id="currentToolPrice" value="10.90" min="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="currentToolLife">T√∂√∂riista eluiga meetrites (m)</label>
                        <input type="number" id="currentToolLife" value="16.43" min="0" step="0.01">
                        <div style="margin-top: 5px; padding: 8px; background: #0a0a0a; border: 1px solid #404040; border-radius: 4px;">
                            <div style="font-size: 0.7em; color: #888; margin-bottom: 3px;">SOOVITUSLIK ELUIGA:</div>
                            <div id="currentLifeEstimate" style="font-size: 0.85em; color: #00ff41;">
                                Arvutatakse parameetrite p√µhjal
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="currentCutLength">L√µikepikkus detaili kohta (mm)</label>
                        <input type="number" id="currentCutLength" value="1000" min="0" step="1"
                               oninput="document.getElementById('newCutLength').value = this.value; calculateTimeEstimate('current'); calculateTimeEstimate('new');">
                    </div>

                    <div style="border-top: 1px solid #404040; margin: 15px 0; padding-top: 15px;">
                        <div style="color: #888; font-size: 0.7em; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px;">L√ïIKEPARAMEETRID</div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="currentDiameter">D - T√∂√∂riista diameeter (mm)</label>
                                <input type="number" id="currentDiameter" value="16" min="0" step="0.1" oninput="calculateTimeEstimate('current')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="currentVC">VC - joonkiirus (m/min)</label>
                                <input type="number" id="currentVC" value="235" min="0" step="1" oninput="calculateTimeEstimate('current')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="currentAp">Ap - l√µikes√ºgavus (mm)</label>
                                <input type="number" id="currentAp" value="0.5" min="0" step="0.1" oninput="calculateTimeEstimate('current')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="currentRPM">S - RPM</label>
                                <input type="number" id="currentRPM" value="1500" min="0" step="1" oninput="calculateTimeEstimate('current')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="currentFeed">F - mm/min</label>
                                <input type="number" id="currentFeed" value="5000" min="0" step="1" oninput="calculateTimeEstimate('current')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="currentAe">Ae - l√µikelaius (mm)</label>
                                <input type="number" id="currentAe" value="1.0" min="0" step="0.1" oninput="calculateTimeEstimate('current')">
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ajakulu/tk (sekundit) <span style="color: #888; font-size: 0.85em;">- arvutatakse automaatselt</span></label>
                        <input id="currentTimePerPart" value="88" type="text" readonly
                               style="background: #1a1a1a; color: #00ff41; cursor: not-allowed;"
                               title="Arvutatakse l√µikepikkuse ja parameetrite p√µhjal">
                        <div style="margin-top: 5px;">
                            <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.75em;">
                                <input type="checkbox" id="currentManualTime" onchange="toggleManualTime('current')"
                                       style="margin-right: 5px; cursor: pointer;">
                                <span style="color: #888;">Sisesta k√§sitsi</span>
                            </label>
                        </div>
                    </div>

                    <div class="tool-info-display" id="currentToolInfo">
                        <div class="tool-info-label">T√ñ√ñRIISTU AASTAS:</div>
                        <div class="tool-info-value" id="currentToolQuantity">0 tk</div>
                    </div>
                </div>

                <!-- New Tool -->
                <div class="tool-column new-tool">
                    <h3>‚ñ≤ UUS T√ñ√ñRIIST (VENTEN)</h3>
                    <div class="input-group">
                        <label for="newToolName">T√∂√∂riista nimi</label>
                        <input type="text" id="newToolName" placeholder="N√§it: Kennametal">
                    </div>
                    <div class="input-group">
                        <label for="newToolPrice">T√∂√∂riista hind (‚Ç¨)</label>
                        <input type="number" id="newToolPrice" value="10.70" min="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="newToolLife">T√∂√∂riista eluiga meetrites (m)</label>
                        <input type="number" id="newToolLife" value="29.75" min="0" step="0.01">
                        <div style="margin-top: 5px; padding: 8px; background: #0a0a0a; border: 1px solid #404040; border-radius: 4px;">
                            <div style="font-size: 0.7em; color: #888; margin-bottom: 3px;">SOOVITUSLIK ELUIGA:</div>
                            <div id="newLifeEstimate" style="font-size: 0.85em; color: #00ff41;">
                                Arvutatakse parameetrite p√µhjal
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="newCutLength">L√µikepikkus detaili kohta (mm)</label>
                        <input type="number" id="newCutLength" value="1000" min="0" step="1">
                    </div>

                    <div style="border-top: 1px solid #404040; margin: 15px 0; padding-top: 15px;">
                        <div style="color: #888; font-size: 0.7em; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px;">L√ïIKEPARAMEETRID</div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="newDiameter">D - T√∂√∂riista diameeter (mm)</label>
                                <input type="number" id="newDiameter" value="16" min="0" step="0.1" oninput="calculateTimeEstimate('new')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="newVC">VC - joonkiirus (m/min)</label>
                                <input type="number" id="newVC" value="235" min="0" step="1" oninput="calculateTimeEstimate('new')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="newAp">Ap - l√µikes√ºgavus (mm)</label>
                                <input type="number" id="newAp" value="1.8" min="0" step="0.1" oninput="calculateTimeEstimate('new')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="newRPM">S - RPM</label>
                                <input type="number" id="newRPM" value="1500" min="0" step="1" oninput="calculateTimeEstimate('new')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="newFeed">F - mm/min</label>
                                <input type="number" id="newFeed" value="5600" min="0" step="1" oninput="calculateTimeEstimate('new')">
                            </div>
                            <div class="input-group" style="margin-bottom: 8px;">
                                <label for="newAe">Ae - l√µikelaius (mm)</label>
                                <input type="number" id="newAe" value="1.0" min="0" step="0.1" oninput="calculateTimeEstimate('new')">
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Ajakulu/tk (sekundit) <span style="color: #888; font-size: 0.85em;">- arvutatakse automaatselt</span></label>
                        <input id="newTimePerPart" value="357" type="text" readonly
                               style="background: #1a1a1a; color: #00ff41; cursor: not-allowed;"
                               title="Arvutatakse l√µikepikkuse ja parameetrite p√µhjal">
                        <div style="margin-top: 5px;">
                            <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.75em;">
                                <input type="checkbox" id="newManualTime" onchange="toggleManualTime('new')"
                                       style="margin-right: 5px; cursor: pointer;">
                                <span style="color: #888;">Sisesta k√§sitsi</span>
                            </label>
                        </div>
                    </div>

                    <div class="tool-info-display" id="newToolInfo">
                        <div class="tool-info-label">T√ñ√ñRIISTU AASTAS:</div>
                        <div class="tool-info-value" id="newToolQuantity">0 tk</div>
                    </div>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateEfficiency()">‚ñ∫ ARVUTA EFEKTIIVSUS</button>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <button class="export-btn" onclick="generatePDFReport()" style="
          padding: 12px;
          background: #1a1a1a;
          color: #00ff41;
          border: 2px solid #00ff41;
          font-size: 0.9em;
          font-weight: 700;
          cursor: pointer;
          text-transform: uppercase;
          letter-spacing: 2px;
          font-family: 'Consolas', monospace;
          transition: all 0.2s;
        " onmouseover="this.style.background='#00ff41'; this.style.color='#000';"
                        onmouseout="this.style.background='#1a1a1a'; this.style.color='#00ff41';">
                    üìÑ GENEREERI PDF
                </button>

                <button class="email-btn" onclick="showEmailDialog()" style="
          padding: 12px;
          background: #1a1a1a;
          color: #0088ff;
          border: 2px solid #0088ff;
          font-size: 0.9em;
          font-weight: 700;
          cursor: pointer;
          text-transform: uppercase;
          letter-spacing: 2px;
          font-family: 'Consolas', monospace;
          transition: all 0.2s;
        " onmouseover="this.style.background='#0088ff'; this.style.color='#000';"
                        onmouseout="this.style.background='#1a1a1a'; this.style.color='#0088ff';">
                    ‚úâÔ∏è SAADA E-MAILILE
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="section results" id="results" style="grid-column: 1 / -1;">
            <h2>[ ANAL√ú√úSI TULEMUSED ]</h2>

            <div class="metrics-grid">
                <div class="metric-card" id="timeSavingsCard">
                    <div class="metric-label">AJAV√ïIT (H)</div>
                    <div class="metric-value" id="timeSavings">0</div>
                </div>
                <div class="metric-card" id="timeEfficiencyCard">
                    <div class="metric-label">EFEKT. KASV (%)</div>
                    <div class="metric-value" id="timeEfficiency">0%</div>
                </div>
                <div class="metric-card" id="toolQuantityCard">
                    <div class="metric-label">T√ñ√ñRIISTU KOKKUHOID</div>
                    <div class="metric-value" id="toolQuantityDiff">0 tk</div>
                </div>
                <div class="metric-card" id="piecesPerToolCard">
                    <div class="metric-label">T√úKKI/T√ñ√ñRIIST Œî</div>
                    <div class="metric-value" id="piecesPerToolDiff">+0</div>
                </div>
                <div class="metric-card" id="toolChangeCostCurrentCard">
                    <div class="metric-label">VAHETUSE KULU (HETKEL)</div>
                    <div class="metric-value" id="toolChangeCurrent">0 ‚Ç¨</div>
                </div>
                <div class="metric-card" id="toolChangeCostNewCard">
                    <div class="metric-label">VAHETUSE KULU (UUS)</div>
                    <div class="metric-value" id="toolChangeNew">0 ‚Ç¨</div>
                </div>
                <div class="metric-card" id="toolChangeSavingsCard">
                    <div class="metric-label">VAHETUSE KOKKUHOID</div>
                    <div class="metric-value" id="toolChangeSavings">0 ‚Ç¨</div>
                </div>
                <div class="metric-card" id="toolCostSavingsCard">
                    <div class="metric-label">T√ñ√ñRIISTA KULU Œî</div>
                    <div class="metric-value" id="toolCostSavings">0 ‚Ç¨</div>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div class="metric-card positive" id="totalSavingsCard">
                    <div class="metric-label">AASTANE KOKKUHOID KOKKU</div>
                    <div class="metric-value" id="totalSavings">0 ‚Ç¨</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>[ AASTANE KULU V√ïRDLUS - EUR ]</h3>
                <div class="comparison-list" id="costComparison"></div>
            </div>

            <div class="chart-container">
                <h3>[ L√ïIKEPARAMEETRITE V√ïRDLUS ]</h3>
                <div id="paramsComparison" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead>
                        <tr style="border-bottom: 2px solid #404040;">
                            <th style="text-align: left; padding: 8px; color: #888; text-transform: uppercase; font-size: 0.75em;">Parameeter</th>
                            <th style="text-align: center; padding: 8px; color: #ff4444; text-transform: uppercase; font-size: 0.75em;">Hetkel</th>
                            <th style="text-align: center; padding: 8px; color: #00ff41; text-transform: uppercase; font-size: 0.75em;">Uus</th>
                            <th style="text-align: center; padding: 8px; color: #888; text-transform: uppercase; font-size: 0.75em;">Œî</th>
                        </tr>
                        </thead>
                        <tbody id="paramsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <h3>[ T√ñ√ñRIISTA ELUIGA V√ïRDLUS - MEETRIT ]</h3>
                    <div class="comparison-list" id="lifeComparison"></div>
                </div>

                <div class="chart-container">
                    <h3>[ T√úKKI/T√ñ√ñRIIST V√ïRDLUS ]</h3>
                    <div class="comparison-list" id="piecesComparison"></div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <h3>[ KOKKUHOIU JAOTUS ]</h3>
                    <canvas id="savingsPieChart" width="300" height="250"></canvas>
                    <div id="pieChartLegend" style="margin-top: 15px; text-align: center;"></div>
                </div>

                <div class="chart-container">
                    <h3>[ EFEKTIIVSUSE V√ïRDLUS ]</h3>
                    <div style="padding: 15px;">
                        <div class="efficiency-bar-wrapper">
                            <div class="efficiency-label">HETKEL KASUTUSEL</div>
                            <div class="efficiency-bar-bg">
                                <div class="efficiency-bar current-eff" id="currentEffBar">100%</div>
                            </div>
                        </div>
                        <div class="efficiency-bar-wrapper" style="margin-top: 15px;">
                            <div class="efficiency-label">UUS T√ñ√ñRIIST</div>
                            <div class="efficiency-bar-bg">
                                <div class="efficiency-bar new-eff" id="newEffBar">120%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="charts-row">
                <div class="savings-indicator" id="savingsIndicator">
                    <div class="savings-indicator-icon">‚óè</div>
                    <div class="savings-indicator-text">KOKKUHOID: 2 373 ‚Ç¨</div>
                    <div class="savings-indicator-subtext">OPTIMAALNE VALIK</div>
                </div>

                <div class="summary">
                    <h3>[ KOKKUV√ïTE ]</h3>
                    <div class="summary-item">
                        <span>CURRENT SYS - ANNUAL COST:</span>
                        <span id="currentAnnualCost">0 ‚Ç¨</span>
                    </div>
                    <div class="summary-item">
                        <span>NEW TOOL - ANNUAL COST:</span>
                        <span id="newAnnualCost">0 ‚Ç¨</span>
                    </div>
                    <div class="summary-item">
                        <span>SAVINGS RATIO:</span>
                        <span id="financialGain">0%</span>
                    </div>
                    <div class="summary-item">
                        <span>TOTAL ANNUAL SAVINGS:</span>
                        <span id="totalAnnualSavings" style="color: #00ff41;">0 ‚Ç¨</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-wrapper">
        <div class="footer-text">Venten ToolBoss v2.0</div>
        <div class="footer-credit">¬© 2026 Venten O√ú | <a href="https://www.venten.ee" target="_blank" rel="noopener noreferrer">www.venten.ee</a></div>
        <div class="footer-divider">
            <div class="footer-developer">Developed by <a href="mailto:laurisoosaar@gmail.com">YRGEL</a></div>
        </div>
    </div>

    <!-- Email Dialog Modal -->
    <div id="emailModal" class="dialog-container">
        <div class="dialog-content">
            <h2 class="dialog-title">üìß SAADA RAPORT E-MAILILE</h2>

            <div class="form-group">
                <label class="form-label" for="recipientEmail">Saaja e-mail:</label>
                <input type="email" id="recipientEmail" placeholder="example@company.com" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label" for="senderEmail">Sinu e-mail (koopia):</label>
                <input type="email" id="senderEmail" placeholder="your@email.com (valikuline)" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label" for="emailMessage">Lisateade (valikuline):</label>
                <textarea id="emailMessage" placeholder="T√§iendav info..." class="form-textarea"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="closeEmailDialog()" class="btn-base btn-close">T√úHISTA</button>
                <button onclick="sendEmail()" class="btn-base btn-send">SAADA</button>
            </div>

            <div id="emailStatus" class="status-message"></div>
        </div>
    </div>

    <!-- scripts: use CDN versions to ensure libraries are available -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Translations loader: load per-language JSON files from /translations/*.json
        const translations = {}; // will hold loaded language objects
        window._currentLang = null;

        async function loadTranslations(lang) {
            try {
                if (translations[lang]) return translations[lang];
                const res = await fetch(`./translations/${lang}.json`);
                if (!res.ok) throw new Error('No translation file');
                const json = await res.json();
                translations[lang] = json;
                return json;
            } catch (err) {
                // fallback: small built-in fallback for essential keys
                console.warn('Translation load failed for', lang, err);
                if (lang === 'en') {
                    translations.en = translations.en || {};
                    return translations.en;
                }
                translations.et = translations.et || {};
                return translations.et;
            }
        }

        function getTranslation(key) {
            const lang = window._currentLang || (localStorage.getItem('toolboss_lang') || 'et');
            const t = translations[lang] || {};
            return (t[key] !== undefined) ? t[key] : key;
        }

        async function applyTranslations(lang) {
            window._currentLang = lang;
            const t = await loadTranslations(lang);

            // Helper to safely set text or HTML for a selector if element exists
            const safeSet = (sel, value, asHtml = false) => {
                try {
                    const el = document.querySelector(sel);
                    if (!el || value === undefined) return false;
                    if (asHtml) el.innerHTML = value; else el.textContent = value;
                    return true;
                } catch (e) {
                    console.warn('safeSet failed for', sel, e);
                    return false;
                }
            };

            // simple selector -> key map for common elements
            const selectorMap = {
                'h1': 'header.title',
                '.header p': 'header.subtitle',
                '.footer-text': 'footer.text',
                '.footer-credit': 'footer.credit',
                '.footer-developer': 'footer.developer',
                'button.calculate-btn': 'btn.calculate',
                'button.export-btn': 'btn.pdf',
                'button.email-btn': 'btn.email',
                '#results h2': 'section.results'
            };

            Object.keys(selectorMap).forEach(sel => {
                const key = selectorMap[sel];
                if (!key || !t[key]) return;
                const asHtml = (sel === '.footer-credit' || sel === '.footer-developer');
                safeSet(sel, t[key], asHtml);
            });

            // Section headings by order (keeps existing behavior)
            const h2s = document.querySelectorAll('.section > h2');
            if (h2s && h2s.length >= 3) {
                h2s[0].textContent = t['section.projectinfo'] || h2s[0].textContent;
                h2s[1].textContent = t['section.machine'] || h2s[1].textContent;
                h2s[2].textContent = t['section.comparison'] || h2s[2].textContent;
            }

            // Chart titles (.chart-container h3) - map by appearance order in the results section
            const chartH3Keys = ['chart.annualCost','chart.paramCompare','chart.lifeCompare','chart.piecesCompare','chart.savingsDistribution','chart.efficiencyCompare'];
            const chartH3s = document.querySelectorAll('.chart-container h3');
            chartH3s.forEach((el, idx) => {
                const key = chartH3Keys[idx];
                if (key && t[key]) el.textContent = t[key];
            });

            // Tool column headings
            const currentToolH3 = document.querySelector('.tool-column.current-tool h3');
            if (currentToolH3 && t['tool.currentHeading']) currentToolH3.textContent = t['tool.currentHeading'];
            const newToolH3 = document.querySelector('.tool-column.new-tool h3');
            if (newToolH3 && t['tool.newHeading']) newToolH3.textContent = t['tool.newHeading'];

            // Metric labels by card id
            const metricMap = {
                'timeSavingsCard': 'metric.timeSavings.label',
                'timeEfficiencyCard': 'metric.timeEfficiency.label',
                'toolQuantityCard': 'metric.toolQuantity.label',
                'piecesPerToolCard': 'metric.piecesPerTool.label',
                'toolChangeCostCurrentCard': 'metric.toolChangeCurrent.label',
                'toolChangeCostNewCard': 'metric.toolChangeNew.label',
                'toolChangeSavingsCard': 'metric.toolChangeSavings.label',
                'toolCostSavingsCard': 'metric.toolCostSavings.label',
                'totalSavingsCard': 'metric.totalSavings.label'
            };
            Object.keys(metricMap).forEach(cardId => {
                const key = metricMap[cardId];
                const card = document.getElementById(cardId);
                if (!card || !t[key]) return;
                const labelEl = card.querySelector('.metric-label');
                if (labelEl) labelEl.textContent = t[key];
            });

            // Summary labels (first span in each .summary-item)
            const summaryKeys = ['summary.currentLabel','summary.newLabel','summary.savingsRatioLabel','summary.totalSavingsLabel'];
            const summarySpans = document.querySelectorAll('.summary .summary-item');
            summarySpans.forEach((item, idx) => {
                const key = summaryKeys[idx];
                if (!key || !t[key]) return;
                const labelSpan = item.querySelector('span');
                if (labelSpan) labelSpan.textContent = t[key];
            });

            // Input placeholders (map by element id)
            const placeholderMap = {
                'client': 'placeholder.client',
                'clientRep': 'placeholder.clientRep',
                'salesRep': 'placeholder.salesRep',
                'machine': 'placeholder.machine',
                'material': 'placeholder.material',
                'batchSize': 'placeholder.batchSize',
                'yearlyQuantity': 'placeholder.yearlyQuantity',
                'currentToolName': 'placeholder.currentToolName',
                'newToolName': 'placeholder.newToolName'
            };
            Object.keys(placeholderMap).forEach(id => {
                const key = placeholderMap[id];
                const el = document.getElementById(id);
                if (el && t[key]) el.placeholder = t[key];
            });

            // Modal labels
            // safer modal label assignment: select all .form-group inside the modal and update labels if found
            (function(){
                try {
                    const modalGroups = document.querySelectorAll('#emailModal .form-group');
                    if (modalGroups && modalGroups.length > 0) {
                        if (t['modal.recipientEmail'] && modalGroups[0]) {
                            const lab = modalGroups[0].querySelector('.form-label') || modalGroups[0].querySelector('label');
                            if (lab) lab.textContent = t['modal.recipientEmail'];
                        }
                        if (t['modal.senderEmail'] && modalGroups[1]) {
                            const lab = modalGroups[1].querySelector('.form-label') || modalGroups[1].querySelector('label');
                            if (lab) lab.textContent = t['modal.senderEmail'];
                        }
                        if (t['modal.emailMessage'] && modalGroups[2]) {
                            const lab = modalGroups[2].querySelector('.form-label') || modalGroups[2].querySelector('label');
                            if (lab) lab.textContent = t['modal.emailMessage'];
                        }
                    }
                } catch (e) {
                    console.warn('applyTranslations: modal label update failed', e);
                }
            })();

            // Upload section labels
            if (t['upload.label']) {
                const upLbl = document.querySelector('.upload-label'); if (upLbl) upLbl.textContent = t['upload.label'];
            }
            if (t['upload.info']) {
                const upInfo = document.querySelector('.upload-info'); if (upInfo) upInfo.textContent = t['upload.info'];
            }
            if (t['photo.placeholder']) {
                const ph = document.querySelector('.photo-placeholder'); if (ph) ph.textContent = t['photo.placeholder'];
            }

            // Chart legend keys (pie chart handled in createPieChart using getTranslation)

            // Any additional label keys using 'label.{id}' format: find label[for="id"] and set text
            Object.keys(t).filter(k => k.startsWith('label.')).forEach(k => {
                const id = k.replace('label.', '');
                const label = document.querySelector('label[for="' + id + '"]');
                if (label) label.textContent = t[k];
            });

            // Also allow 'text.' prefixed keys to map to selectors directly
            Object.keys(t).filter(k => k.startsWith('text.')).forEach(k => {
                const sel = k.replace('text.', '');
                const el = document.querySelector(sel);
                if (el) el.textContent = t[k];
            });

            // Fallback direct phrase replacements for static nodes that don't have selectors
            const fallbackTextMap = {
                'L√ïIKEPARAMEETRID': 'label.cutParams',
                'SOOVITUSLIK ELUIGA:': 'label.recommendedLife',
                'Ajakulu/tk (sekundit) - arvutatakse automaatselt': 'label.timePerPartDesc',
                '√úkski pilt pole √ºles laaditud': 'photo.placeholder',
                'Laadi pilt': 'upload.button',
                'PNG, JPG, GIF (max 5MB) - Masina sildilt pilt': 'upload.info'
            };

            // Replace exact text-only nodes matching keys above
            const all = document.querySelectorAll('body *');
            all.forEach(el => {
                if (el.childElementCount === 0) {
                    const txt = (el.textContent || '').trim();
                    if (fallbackTextMap[txt] && t[fallbackTextMap[txt]]) {
                        el.textContent = t[fallbackTextMap[txt]];
                    }
                }
            });
        }

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        // Some embed/dev hosts may remove the toggle; guard accesses
        if (themeToggle) {
            // Check for saved theme preference or default to dark mode
            const currentTheme = localStorage.getItem('theme') || 'dark';
            if (currentTheme === 'light') {
                document.body.classList.add('light-mode');
                try { themeToggle.checked = true; } catch (e) {}
            }

            // Listen for toggle changes
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('light-mode');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.body.classList.remove('light-mode');
                    localStorage.setItem('theme', 'dark');
                }
            });
        }

        // --- TRANSLATIONS: provide local defaults and wire language selector ---
        // Use external JSON files under /translations/*.json for translations.
        // When served via HTTP the files `translations/et.json` and `translations/en.json` are loaded by `loadTranslations()`.
        // For local file:// editing, translations may not be available; in that case `loadTranslations()` will return an empty object and
        // `applyTranslations()` will leave existing static text in place.
        //
        // Built-in translations are removed to avoid duplicate keys; use external files only.
        // Ensure default translation objects exist so applyTranslations has something to merge
        translations.et = Object.assign({}, translations.et || {});
        translations.en = Object.assign({}, translations.en || {});

        // Wire the language selector and apply language on load
        (function() {
            const langSelect = document.getElementById('langSelect');
            const savedLang = localStorage.getItem('toolboss_lang') || 'et';
            // Set the select value if element exists
            if (langSelect) {
                langSelect.value = savedLang;
                langSelect.addEventListener('change', function(e) {
                    const newLang = e.target.value || 'et';
                    localStorage.setItem('toolboss_lang', newLang);
                    applyTranslations(newLang).catch(err => console.warn('applyTranslations failed', err));
                });
            }

            // Apply translations on initial load
            // prefer savedLang, or default to 'et'
            applyTranslations(savedLang).catch(err => console.warn('Initial applyTranslations failed', err));
        })();

        // Toggle manual time input
        function toggleManualTime(tool) {
            const checkbox = document.getElementById(tool + 'ManualTime');
            const input = document.getElementById(tool + 'TimePerPart');

            if (checkbox.checked) {
                input.readOnly = false;
                input.style.background = '#2a2a2a';
                input.style.cursor = 'text';
                input.style.color = '#00ff41';
                // Enable calculator function
                input.oninput = function() {
                    try { this.value = Function('return ' + this.value)() }
                    catch(e) {}
                };
            } else {
                input.readOnly = true;
                input.style.background = '#1a1a1a';
                input.style.cursor = 'not-allowed';
                input.oninput = null;
                calculateTimeEstimate(tool);
            }
        }

        // Efficiency bar updater (defined before calculateEfficiency to avoid ReferenceError)
        function updateEfficiencyBars(currentValue, newValue) {
            try {
                const currentBar = document.getElementById('currentEffBar');
                const newBar = document.getElementById('newEffBar');
                // Normalize to percentage numbers
                const c = (typeof currentValue === 'number') ? currentValue : (parseFloat(currentValue) || 0);
                const n = (typeof newValue === 'number') ? newValue : (parseFloat(newValue) || 0);
                if (currentBar) {
                    currentBar.style.width = Math.max(0, Math.min(200, c)) + '%';
                    currentBar.textContent = Math.round(c) + '%';
                }
                if (newBar) {
                    newBar.style.width = Math.max(0, Math.min(200, n)) + '%';
                    newBar.textContent = Math.round(n) + '%';
                }
            } catch (e) { console.warn('updateEfficiencyBars error', e); }
        }

        // Savings indicator updater
        function updateSavingsIndicator(totalSavings) {
            try {
                const el = document.getElementById('savingsIndicator');
                if (!el) return;
                const textEl = el.querySelector('.savings-indicator-text');
                if (textEl) textEl.textContent = 'KOKKUHOID: ' + (isNaN(totalSavings) ? '0 ‚Ç¨' : Number(totalSavings).toFixed(0) + ' ‚Ç¨');
                // adjust color based on amount
                if (totalSavings > 0) el.style.borderLeft = '4px solid var(--accent-green)';
                else if (totalSavings < 0) el.style.borderLeft = '4px solid var(--accent-red)';
                else el.style.borderLeft = '4px solid var(--border-color)';
            } catch (e) { console.warn('updateSavingsIndicator error', e); }
        }

        // Calculate estimated time based on parameters
        function calculateTimeEstimate(tool) {
            // Skip if manual mode is enabled
            const manualCheckbox = document.getElementById(tool + 'ManualTime');
            if (manualCheckbox && manualCheckbox.checked) return;

            try {
                const cutLength = parseFloat(document.getElementById(tool + 'CutLength').value) || 0;
                const feed = parseFloat(document.getElementById(tool + 'Feed').value) || 1;
                const vc = parseFloat(document.getElementById(tool + 'VC').value) || 0;
                const rpm = parseFloat(document.getElementById(tool + 'RPM').value) || 0;
                const diameter = parseFloat(document.getElementById(tool + 'Diameter').value) || 0;

                // Calculate theoretical RPM from VC and diameter
                // VC = œÄ √ó D √ó n / 1000, therefore n = (VC √ó 1000) / (œÄ √ó D)
                if (diameter > 0 && vc > 0) {
                    const theoreticalRPM = (vc * 1000) / (Math.PI * diameter);

                    // Check if user-entered RPM is significantly different from theoretical
                    if (rpm > 0) {
                        const difference = Math.abs((rpm - theoreticalRPM) / theoreticalRPM * 100);
                        if (difference > 10) {
                            console.warn(`${tool}: RPM (${rpm}) differs ${difference.toFixed(0)}% from theoretical (${theoreticalRPM.toFixed(0)}) based on VC and diameter`);
                        }
                    }
                }

                if (cutLength === 0 || feed === 0) {
                    document.getElementById(tool + 'TimePerPart').value = '0';
                    return;
                }

                // Calculate pure cutting time
                const cuttingTime = (cutLength / feed) * 60; // seconds

                // Add rapid positioning and approach time (typically 20-30% overhead)
                const positioningOverhead = 1.25; // 25% overhead
                const totalTime = cuttingTime * positioningOverhead;

                // Add tool approach and retract (estimated 2-5 seconds)
                const approachTime = 3; // seconds

                const estimatedTime = totalTime + approachTime;

                // Update the field
                document.getElementById(tool + 'TimePerPart').value = Math.round(estimatedTime);

                // Calculate tool life estimate
                calculateToolLifeEstimate(tool);

                // Show calculation breakdown in console for debugging
                console.log(`${tool} time estimate:`, {
                    cutLength: cutLength + 'mm',
                    feed: feed + 'mm/min',
                    diameter: diameter + 'mm',
                    vc: vc + 'm/min',
                    rpm: rpm,
                    cuttingTime: cuttingTime.toFixed(1) + 's',
                    withOverhead: totalTime.toFixed(1) + 's',
                    total: estimatedTime.toFixed(1) + 's'
                });

            } catch (error) {
                console.error('Error calculating time estimate:', error);
            }
        }

        // Calculate tool life estimate based on Taylor's equation and cutting parameters
        function calculateToolLifeEstimate(tool) {
            try {
                const vc = parseFloat(document.getElementById(tool + 'VC').value) || 0;
                const ap = parseFloat(document.getElementById(tool + 'Ap').value) || 0;
                const ae = parseFloat(document.getElementById(tool + 'Ae').value) || 0;
                const feed = parseFloat(document.getElementById(tool + 'Feed').value) || 0;
                const diameter = parseFloat(document.getElementById(tool + 'Diameter').value) || 0;
                const coolant = document.getElementById('coolant').value;

                if (vc === 0) {
                    document.getElementById(tool + 'LifeEstimate').innerHTML =
                        '<span style="color: #ff4444;">Sisesta l√µikekiirus (VC)</span>';
                    return;
                }

                // Base tool life at reference conditions (VC=100 m/min for carbide on steel)
                // These are conservative estimates
                const baseLife = 50; // meters at VC=100
                const referenceVC = 100;

                // Taylor's exponent (n) - varies by material combination
                // Steel: n ‚âà 0.25, Aluminum: n ‚âà 0.3, Stainless: n ‚âà 0.2
                const taylorN = 0.25; // Conservative for steel

                // Coolant factor - affects tool life significantly
                const coolantFactors = {
                    'emulsion': 1.0,        // Baseline - good cooling
                    'oil': 1.15,            // Better lubrication, +15%
                    'synthetic': 1.10,      // Good cooling, +10%
                    'semi-synthetic': 1.05, // Balanced, +5%
                    'dry': 0.70,            // No cooling, -30%
                    'mql': 0.85,            // Minimal cooling, -15%
                    'air': 0.75             // Air only, -25%
                };
                const coolantFactor = coolantFactors[coolant] || 1.0;

                // Calculate estimated life using modified Taylor equation
                // T = C / (VC^n)
                const vcRatio = vc / referenceVC;
                const lifeFactor = Math.pow(vcRatio, -1/taylorN);

                // MRR (Material Removal Rate) adjustment
                const mrr = ap * ae * feed; // mm¬≥/min
                const referenceMRR = 1000; // reference MRR
                const mrrFactor = Math.max(0.5, Math.min(1.5, referenceMRR / (mrr || 1)));

                // Diameter factor - smaller tools wear faster
                let diameterFactor = 1.0;
                if (diameter > 0) {
                    const referenceDiameter = 12; // mm
                    diameterFactor = Math.pow(diameter / referenceDiameter, 0.15); // Small effect
                    diameterFactor = Math.max(0.8, Math.min(1.2, diameterFactor)); // Clamp
                }

                // Final estimated life with coolant and diameter factors
                let estimatedLife = baseLife * lifeFactor * mrrFactor * coolantFactor * diameterFactor;

                // Clamp to reasonable range
                estimatedLife = Math.max(5, Math.min(200, estimatedLife));

                // Display the estimate with explanation
                const displayDiv = document.getElementById(tool + 'LifeEstimate');
                const comparison = parseFloat(document.getElementById(tool + 'ToolLife').value) || 0;

                let statusColor = '#00ff41';
                let statusText = 'OPTIMAALNE';

                if (comparison > 0) {
                    const ratio = comparison / estimatedLife;
                    if (ratio > 1.3) {
                        statusColor = '#ffaa00';
                        statusText = 'OPTIMISTLIK (+' + ((ratio - 1) * 100).toFixed(0) + '%)';
                    } else if (ratio < 0.7) {
                        statusColor = '#00ff41';
                        statusText = 'KONSERVATIIVNE (-' + ((1 - ratio) * 100).toFixed(0) + '%)';
                    }
                }

                // Coolant description for display
                const coolantNames = {
                    'emulsion': 'Emuls',
                    'oil': '√ïli',
                    'synthetic': 'S√ºnt',
                    'semi-synthetic': 'Semi',
                    'dry': 'Kuiv',
                    'mql': 'MQL',
                    'air': '√ïhk'
                };

                displayDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>${estimatedLife.toFixed(1)} m</span>
            <span style="color: ${statusColor}; font-size: 0.75em;">${statusText}</span>
          </div>
          <div style="font-size: 0.65em; color: #666; margin-top: 3px;">
            D${diameter}mm, VC${vc}, MRR${mrr.toFixed(0)}, ${coolantNames[coolant]}√ó${coolantFactor.toFixed(2)}
          </div>
        `;

            } catch (error) {
                console.error('Error calculating tool life estimate:', error);
            }
        }

        function getNumber(id, defaultValue = 0) {
            try {
                const el = document.getElementById(id);
                if (!el) return defaultValue;
                const v = parseFloat(el.value);
                return isNaN(v) ? defaultValue : v;
            } catch (e) {
                console.warn('getNumber error for', id, e);
                return defaultValue;
            }
        }

        function getString(id, defaultValue = '') {
            try {
                const el = document.getElementById(id);
                if (!el) return defaultValue;
                return (el.value || defaultValue).toString();
            } catch (e) {
                console.warn('getString error for', id, e);
                return defaultValue;
            }
        }

        function calculateEfficiency() {
            try {
                // Safe reads using helpers
                const yearlyQuantity = getNumber('yearlyQuantity', 0);
                const machineRate = getNumber('machineRate', 0);
                const toolChangeTime = getNumber('toolChangeTime', 0);

                // Current tool
                const currentToolPrice = getNumber('currentToolPrice', 0);
                const currentToolLife = getNumber('currentToolLife', 0);
                const currentCutLength = getNumber('currentCutLength', 0);
                const currentTimePerPart = getNumber('currentTimePerPart', 0);
                const currentToolName = getString('currentToolName', 'Hetkel kasutusel');

                // New tool
                const newToolPrice = getNumber('newToolPrice', 0);
                const newToolLife = getNumber('newToolLife', 0);
                const newCutLength = getNumber('newCutLength', 0);
                const newTimePerPart = getNumber('newTimePerPart', 0);
                const newToolName = getString('newToolName', 'Uus t√∂√∂riist');

                // Calculate pieces per tool safely
                const currentPiecesPerTool = (currentCutLength > 0 && currentToolLife > 0) ? Math.floor(currentToolLife * 1000 / currentCutLength) : 0;
                const newPiecesPerTool = (newCutLength > 0 && newToolLife > 0) ? Math.floor(newToolLife * 1000 / newCutLength) : 0;

                const currentToolQuantityNeeded = currentPiecesPerTool > 0 ? Math.ceil(yearlyQuantity / currentPiecesPerTool) : 0;
                const newToolQuantityNeeded = newPiecesPerTool >  0 ? Math.ceil(yearlyQuantity / newPiecesPerTool) : 0;

                // Update UI safely
                const safeSetText = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
                safeSetText('currentToolQuantity', currentToolQuantityNeeded + ' tk');
                safeSetText('newToolQuantity', newToolQuantityNeeded + ' tk');
                safeSetText('toolQuantityDiff', (currentToolQuantityNeeded - newToolQuantityNeeded) + ' tk');

                const currentToolCostPerYear = currentToolPrice * currentToolQuantityNeeded;
                const newToolCostPerYear = newToolPrice * newToolQuantityNeeded;
                const toolCostDifference = currentToolCostPerYear - newToolCostPerYear;

                // Tool change costs
                const currentToolChangesPerYear = currentPiecesPerTool > 0 ? yearlyQuantity / currentPiecesPerTool : 0;
                const newToolChangesPerYear = newPiecesPerTool > 0 ? yearlyQuantity / newPiecesPerTool : 0;
                const currentToolChangeHours = (toolChangeTime / 3600) * currentToolChangesPerYear;
                const newToolChangeHours = (toolChangeTime / 3600) * newToolChangesPerYear;
                const currentToolChangeCost = currentToolChangeHours * machineRate;
                const newToolChangeCost = newToolChangeHours * machineRate;
                const toolChangeSavings = currentToolChangeCost - newToolChangeCost;

                safeSetText('toolChangeCurrent', currentToolChangeCost.toFixed(0) + ' ‚Ç¨');
                safeSetText('toolChangeNew', newToolChangeCost.toFixed(0) + ' ‚Ç¨');
                safeSetText('toolChangeSavings', toolChangeSavings.toFixed(0) + ' ‚Ç¨');

                // Time savings and totals
                const currentTimePerYear = (currentTimePerPart * yearlyQuantity) / 3600; // hours
                const newTimePerYear = (newTimePerPart * yearlyQuantity) / 3600; // hours
                const timeSavingsHours = currentTimePerYear - newTimePerYear;
                const machineCostSavings = timeSavingsHours * machineRate;
                const totalAnnualSavings = toolCostDifference + machineCostSavings + toolChangeSavings;

                const timeEfficiencyIncrease = currentTimePerYear > 0 ? ((currentTimePerYear - newTimePerYear) / currentTimePerYear * 100) : 0;

                const currentTotalCost = currentToolCostPerYear + (currentTimePerYear * machineRate) + currentToolChangeCost;
                const newTotalCost = newToolCostPerYear + (newTimePerYear * machineRate) + newToolChangeCost;
                const financialGain = currentTotalCost > 0 ? ((currentTotalCost - newTotalCost) / currentTotalCost * 100) : 0;

                safeSetText('timeSavings', (isNaN(timeSavingsHours) ? 0 : timeSavingsHours).toFixed(1));
                safeSetText('timeEfficiency', (isNaN(timeEfficiencyIncrease) ? 0 : timeEfficiencyIncrease.toFixed(1)) + '%');
                safeSetText('toolCostSavings', (isNaN(toolCostDifference) ? 0 : toolCostDifference).toFixed(0) + ' ‚Ç¨');
                safeSetText('totalSavings', (isNaN(totalAnnualSavings) ? 0 : totalAnnualSavings).toFixed(0) + ' ‚Ç¨');

                const piecesDiff = newPiecesPerTool - currentPiecesPerTool;
                safeSetText('piecesPerToolDiff', (piecesDiff >= 0 ? '+' : '') + (isNaN(piecesDiff) ? 0 : piecesDiff));

                // // // // // Update parameter table and summary
                updateParametersTable();
                safeSetText('currentAnnualCost', currentTotalCost.toFixed(0) + ' ‚Ç¨');
                safeSetText('newAnnualCost', newTotalCost.toFixed(0) + ' ‚Ç¨');
                safeSetText('financialGain', (isNaN(financialGain) ? 0 : financialGain.toFixed(0)) + '%');
                safeSetText('totalAnnualSavings', (isNaN(totalAnnualSavings) ? 0 : totalAnnualSavings).toFixed(0) + ' ‚Ç¨');

                // Color code metrics and create comparisons
                colorCodeMetric('timeSavingsCard', timeSavingsHours);
                colorCodeMetric('timeEfficiencyCard', parseFloat(timeEfficiencyIncrease));
                colorCodeMetric('toolCostSavingsCard', toolCostDifference);
                colorCodeMetric('piecesPerToolCard', piecesDiff);
                colorCodeMetric('toolQuantityCard', currentToolQuantityNeeded - newToolQuantityNeeded);
                colorCodeMetric('toolChangeSavingsCard', toolChangeSavings);

                createComparisonList('costComparison', [
                    { label: currentToolName, value: currentTotalCost, class: 'current' },
                    { label: newToolName, value: newTotalCost, class: 'new' }
                ], '‚Ç¨');

                createComparisonList('lifeComparison', [
                    { label: currentToolName, value: currentToolLife, class: 'current' },
                    { label: newToolName, value: newToolLife, class: 'new' }
                ], 'm');

                createComparisonList('piecesComparison', [
                    { label: currentToolName, value: currentPiecesPerTool, class: 'current' },
                    { label: newToolName, value: newPiecesPerTool, class: 'new' }
                ], 'tk');

                createPieChart(toolCostDifference + toolChangeSavings, machineCostSavings);

                updateEfficiencyBars(currentTimePerYear, newTimePerYear);
                updateSavingsIndicator(totalAnnualSavings);

                const resultsEl = document.getElementById('results');
                if (resultsEl) resultsEl.classList.add('show');
                if (resultsEl) resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Calculation error:', error);
                // Show detailed error in UI so user can debug when running locally
                const resultsEl = document.getElementById('results');
                if (resultsEl) {
                    resultsEl.classList.add('show');
                    // create or update an error box
                    let errBox = document.getElementById('calcErrorBox');
                    if (!errBox) {
                        errBox = document.createElement('div');
                        errBox.id = 'calcErrorBox';
                        errBox.style.background = '#ffefef';
                        errBox.style.color = '#660000';
                        errBox.style.border = '1px solid #ff4444';
                        errBox.style.padding = '10px';
                        errBox.style.margin = '10px 0';
                        errBox.style.whiteSpace = 'pre-wrap';
                        resultsEl.insertBefore(errBox, resultsEl.firstChild);
                    }
                    errBox.textContent = 'Arvutusviga: ' + (error && error.message ? error.message : String(error)) + '\nVaadake konsooli t√§psema info saamiseks.';
                } else {
                    alert('Arvutusviga: ' + (error && error.message ? error.message : String(error)));
                }
            }
        }

        // Drag and drop support for photo upload
        const uploadSection = document.getElementById('uploadSection');
        if (uploadSection) {
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // Attempt to set the input.files using DataTransfer (supported in modern browsers)
                    const input = document.getElementById('machinePhoto');
                    try {
                        const dt = new DataTransfer();
                        for (let i = 0; i < files.length; i++) dt.items.add(files[i]);
                        input.files = dt.files;
                    } catch (err) {
                        // Fallback: not all environments allow assigning input.files
                        console.warn('Could not set input.files programmatically', err);
                    }
                    // Call handler with the FileList
                    handlePhotoUpload({ target: { files: files } });
                }
            });
        }

        // Improved photo upload handler: accept event or direct FileList/Array
        function handlePhotoUpload(eventOrFiles) {
            try {
                // Normalize files
                let files = null;
                if (!eventOrFiles) return;
                if (eventOrFiles.target && eventOrFiles.target.files) files = eventOrFiles.target.files;
                else if (eventOrFiles instanceof FileList) files = eventOrFiles;
                else if (Array.isArray(eventOrFiles)) files = eventOrFiles;
                else if (eventOrFiles.files) files = eventOrFiles.files;
                if (!files || files.length === 0) return;

                const file = files[0];
                const uploadSection = document.getElementById('uploadSection');
                const imageContainer = document.getElementById('imageContainer');

                // Validate file size (max 5MB)
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (file.size > maxSize) {
                    alert('‚ùå Pilt on liiga suur. Maksimum 5MB.');
                    // Clear input if present
                    const input = document.getElementById('machinePhoto'); if (input) input.value = '';
                    return;
                }

                // Validate file type
                const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    alert('‚ùå Vale piltide vorming. Kasutage PNG, JPG v√µi GIF.');
                    const input = document.getElementById('machinePhoto'); if (input) input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    if (!imageContainer) return;
                    imageContainer.innerHTML = '';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'uploaded-image';

                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = '‚úï Eemalda pilt';
                    removeBtn.style.cssText = `
                    display: block;
                    width: 100%;
                    margin-top: 8px;
                    padding: 6px;
                    background: var(--accent-red);
                    color: #fff;
                    border: 1px solid var(--accent-red);
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 0.75em;
                    text-transform: uppercase;
                    font-family: Consolas, monospace;
                    transition: all 0.2s;
                `;
                    removeBtn.onmouseover = function() { this.style.background = '#ff6666'; };
                    removeBtn.onmouseout = function() { this.style.background = 'var(--accent-red)'; };
                    removeBtn.onclick = function() {
                        imageContainer.innerHTML = '<div class="photo-placeholder">√úkski pilt pole √ºles laaditud</div>';
                        const input = document.getElementById('machinePhoto'); if (input) input.value = '';
                        if (uploadSection) uploadSection.style.borderColor = 'var(--border-color)';
                    };

                    imageContainer.appendChild(img);
                    imageContainer.appendChild(removeBtn);
                    if (uploadSection) uploadSection.style.borderColor = 'var(--accent-green)';
                };
                reader.readAsDataURL(file);
            } catch (ex) {
                console.error('handlePhotoUpload error', ex);
            }
        }

        function updateParametersTable() {
            // Clear existing table rows
            const tbody = document.getElementById('paramsTableBody');
            if (tbody) {
                tbody.innerHTML = '';
            }

            // Get current and new tool parameters safely
            const safeVal = id => { const el = document.getElementById(id); return el ? (el.value || '') : ''; };

            const currentParams = [
                { label: 'D - T√∂√∂riista diameeter (mm)', current: safeVal('currentDiameter'), new: safeVal('newDiameter') },
                { label: 'VC - joonkiirus (m/min)', current: safeVal('currentVC'), new: safeVal('newVC') },
                { label: 'Ap - l√µikes√ºgavus (mm)', current: safeVal('currentAp'), new: safeVal('newAp') },
                { label: 'S - RPM', current: safeVal('currentRPM'), new: safeVal('newRPM') },
                { label: 'F - mm/min', current: safeVal('currentFeed'), new: safeVal('newFeed') },
                { label: 'Ae - l√µikelaius (mm)', current: safeVal('currentAe'), new: safeVal('newAe') }
            ];

            if (!tbody) return;

            // Add rows to the table
            currentParams.forEach(param => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #404040';
                row.innerHTML = `
          <td style="padding: 8px; color: #e0e0e0; font-size: 0.85em;">${param.label}</td>
          <td style="padding: 8px; text-align: center;">
            <div style="position: relative;">
              <div style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-size: 0.7em; color: #888;"></div>
              <input type="text" value="${param.current}" readonly style="background: #1a1a1a; color: #00ff41; border: none; padding: 8px 10px; border-radius: 4px; width: 100%; box-shadow: inset 0 0 5px rgba(0, 255, 65, 0.3);">
            </div>
          </td>
          <td style="padding: 8px; text-align: center;">
            <div style="position: relative;">
              <div style="position: absolute; top: 50%; left: 10px; transform: translateY(-50%); font-size: 0.7em; color: #888;"></div>
              <input type="text" value="${param.new}" readonly style="background: #1a1a1a; color: #00ff41; border: none; padding: 8px 10px; border-radius: 4px; width: 100%; box-shadow: inset 0 0 5px rgba(0, 255, 65, 0.3);">
            </div>
          </td>
        `;
                tbody.appendChild(row);
            });
        }

        // Helper: color-code metric cards
        function colorCodeMetric(cardId, value) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.remove('positive', 'negative');
            if (typeof value !== 'number') {
                value = parseFloat(value) || 0;
            }
            if (value > 0) card.classList.add('positive');
            else if (value < 0) card.classList.add('negative');
        }

        // Create a comparison list for simple label/value items
        function createComparisonList(containerId, data, unit) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            data.forEach(item => {
                const compItem = document.createElement('div');
                compItem.className = 'comparison-item ' + (item.class || '');

                const value = document.createElement('div');
                value.className = 'comparison-value';
                const numValue = isNaN(item.value) ? 0 : item.value;
                const display = (typeof numValue === 'number') ? (numValue >= 100 ? Math.round(numValue) : (Math.round(numValue * 10) / 10)) : numValue;
                value.textContent = display + ' ' + (unit || '');

                const label = document.createElement('div');
                label.className = 'comparison-label';
                label.textContent = item.label || '';

                compItem.appendChild(value);
                compItem.appendChild(label);
                container.appendChild(compItem);
            });
        }

        // Draw a simple pie chart on canvas and update legend
        function createPieChart(toolSavings, timeSavings) {
            const canvas = document.getElementById('savingsPieChart');
            const legend = document.getElementById('pieChartLegend');
            if (!legend) return;

            // If no canvas available, still generate legend
            if (!canvas || !canvas.getContext) {
                const total = Math.abs(toolSavings) + Math.abs(timeSavings);
                const toolPct = total ? Math.round((Math.abs(toolSavings) / total) * 100) : 0;
                const timePct = total ? 100 - toolPct : 0;
                legend.innerHTML = buildPieLegendHtml(toolPct, timePct);
                return;
            }

            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) / 2 - 10;

            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const total = Math.abs(toolSavings) + Math.abs(timeSavings);
            if (total === 0) {
                // draw empty circle
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
                legend.innerHTML = `<div class="pie-legend-item"><div class="legend-info"><div class="dot" style="background:#666"></div><div class="legend-label">${getTranslation('chart.noData') || 'No data'}</div></div><div class="legend-pct">0%</div></div>`;
                return;
            }

            let angle = -Math.PI / 2;
            const toolAngle = (Math.abs(toolSavings) / total) * Math.PI * 2;
            ctx.fillStyle = '#00ff41';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, angle, angle + toolAngle);
            ctx.closePath();
            ctx.fill();
            angle += toolAngle;

            const timeAngle = (Math.abs(timeSavings) / total) * Math.PI * 2;
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, angle, angle + timeAngle);
            ctx.closePath();
            ctx.fill();

            // inner circle for donut look
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-primary') || '#1a1a1a';
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.6, 0, Math.PI * 2);
            ctx.fill();

            // center large value (total savings)
            ctx.fillStyle = '#00ff41';
            ctx.font = 'bold 18px Consolas, monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const totalLabel = (Math.abs(toolSavings) + Math.abs(timeSavings)).toFixed(0) + '‚Ç¨';
            ctx.fillText(totalLabel, centerX, centerY - 6);
            ctx.font = '12px Consolas, monospace';
            ctx.fillStyle = '#888';
            ctx.fillText(getTranslation('chart.totalLabel') || 'TOTAL', centerX, centerY + 14);

            // Legend HTML
            const toolPct = total ? Math.round((Math.abs(toolSavings) / total) * 100) : 0;
            const timePct = total ? 100 - toolPct : 0;
            legend.innerHTML = buildPieLegendHtml(toolPct, timePct);
        }

        function buildPieLegendHtml(toolPct, timePct) {
            const toolLabel = getTranslation('chart.toolSlice') || 'Tool';
            const timeLabel = getTranslation('chart.timeSlice') || 'Time';
            return `
                <div class="pie-legend">
                    <div class="pie-legend-item">
                        <div class="legend-info"><div class="dot" style="background:#00ff41"></div><div class="legend-label">${toolLabel}</div></div>
                        <div class="legend-pct">${toolPct}%</div>
                    </div>
                    <div class="pie-legend-item">
                        <div class="legend-info"><div class="dot" style="background:#0088ff"></div><div class="legend-label">${timeLabel}</div></div>
                        <div class="legend-pct">${timePct}%</div>
                    </div>
                </div>
            `;
        }

        // Expose helpers to window as well
        try { window.colorCodeMetric = colorCodeMetric; } catch (e) {}
        try { window.createComparisonList = createComparisonList; } catch (e) {}
        try { window.createPieChart = createPieChart; } catch (e) {}
        try { window.updateEfficiencyBars = updateEfficiencyBars; } catch (e) {}
        try { window.updateSavingsIndicator = updateSavingsIndicator; } catch (e) {}

        // Generate PDF from the main container using html2canvas + jsPDF
        async function generatePDFBlob() {
            try {
                const el = document.querySelector('.container') || document.body;
                // Ensure libraries are available
                const html2canvasFn = window.html2canvas || window.html2canvas;
                const jspdfLib = window.jspdf || window.jspdf;
                const jsPDF = jspdfLib && jspdfLib.jsPDF ? jspdfLib.jsPDF : (window.jsPDF || null);
                if (!html2canvasFn || !jsPDF) throw new Error('Required libraries (html2canvas / jsPDF) missing');

                const canvas = await html2canvas(el, { scale: 2, useCORS: true, allowTaint: false });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                // calculate the height of the image in PDF units
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidthMm = pageWidth;
                const imgHeightMm = (imgProps.height * imgWidthMm) / imgProps.width;

                if (imgHeightMm <= pageHeight) {
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidthMm, imgHeightMm);
                } else {
                    // If content is longer than one page, scale down to fit the page height
                    const scale = pageHeight / imgHeightMm;
                    const newWidth = imgWidthMm * scale;
                    const newHeight = imgHeightMm * scale;
                    const x = (pageWidth - newWidth) / 2;
                    pdf.addImage(imgData, 'JPEG', x, 0, newWidth, newHeight);
                }

                const arrayBuf = pdf.output('arraybuffer');
                return new Blob([arrayBuf], { type: 'application/pdf' });
            } catch (err) {
                console.error('generatePDFBlob error', err);
                throw err;
            }
        }

        // Create a structured, text-based PDF using jsPDF and canvas images for charts
        async function generateStructuredPDF() {
            try {
                const jspdfLib = window.jspdf || window.jspdf;
                const jsPDF = jspdfLib && jspdfLib.jsPDF ? jspdfLib.jsPDF : (window.jsPDF || null);
                if (!jsPDF) throw new Error('jsPDF library is missing');

                const pdf = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                const marginLeft = 18;
                const pageWidth = pdf.internal.pageSize.getWidth();
                const usableWidth = pageWidth - marginLeft * 2;
                let y = 18;

                // Cover page
                try {
                    // logo on top-right (external link may be blocked if not allowed by CORS; ignore on failure)
                    const logoUrl = 'https://www.venten.ee/static/version1769687684/frontend/Zaproo/venten/et_EE/images/logo.png';
                    // attempt to fetch image as blob and embed
                    try {
                        const resp = await fetch(logoUrl, { mode: 'cors' });
                        if (resp.ok) {
                            const blob = await resp.blob();
                            const dataUrl = await new Promise((res, rej) => {
                                const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(blob);
                            });
                            pdf.addImage(dataUrl, 'PNG', pageWidth - marginLeft - 36, 12, 36, 36);
                        }
                    } catch (e) { /* ignore logo embedding errors */ }

                    pdf.setFontSize(22);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor('#00aa00');
                    pdf.text('Venten ToolBoss', marginLeft, 50);
                    pdf.setFontSize(12);
                    pdf.setTextColor('#888888');
                    pdf.setFont('helvetica','normal');
                    const subtitle = (document.getElementById('machine') || {}).value || 'Tool comparison report';
                    pdf.text(subtitle, marginLeft, 58);
                    pdf.setDrawColor(220);
                    pdf.setLineWidth(0.5);
                    pdf.line(marginLeft, 68, pageWidth - marginLeft, 68);

                    pdf.setFontSize(10);
                    pdf.setTextColor('#666');
                    pdf.text('Generated: ' + ((document.getElementById('testDate') && document.getElementById('testDate').value) || new Date().toISOString().slice(0,10)), marginLeft, 78);
                    pdf.addPage();
                    y = 18;
                } catch (e) { console.warn('Cover generation failed', e); }

                // Project info
                pdf.setFontSize(11);
                pdf.setTextColor('#00aa00');
                pdf.setFont('helvetica', 'bold');
                pdf.text('Project information', marginLeft, y);
                y += 8;

                pdf.setFontSize(10);
                pdf.setTextColor('#222');
                pdf.setFont('helvetica', 'normal');
                const read = id => (document.getElementById(id) ? (document.getElementById(id).value || '') : '');
                const pairs = [
                    ['Client', read('client')],
                    ['Client rep', read('clientRep')],
                    ['Sales rep', read('salesRep')],
                    ['Machine', read('machine')],
                    ['Application', read('application')],
                    ['Material', read('material')],
                    ['Coolant', read('coolant')]
                ];

                pairs.forEach(([k, v]) => {
                    if (y > 260) { pdf.addPage(); y = 15; }
                    pdf.setFont('helvetica', 'bold'); pdf.setTextColor('#444'); pdf.text(k + ':', marginLeft, y);
                    pdf.setFont('helvetica', 'normal'); pdf.setTextColor('#111'); pdf.text(String(v), marginLeft + 50, y);
                    y += 7;
                });
                y += 6;

                // Tool comparison summary table header
                pdf.setFontSize(11);
                pdf.setTextColor('#00aa00');
                pdf.setFont('helvetica', 'bold');
                pdf.text('Tool comparison summary', marginLeft, y);
                y += 8;

                // Simple table: Parameter | Current | New (draw lines and header background)
                const tableCols = [70, 60, 60]; // widths
                const tableStartX = marginLeft;
                const colX = [tableStartX, tableStartX + tableCols[0], tableStartX + tableCols[0] + tableCols[1]];

                pdf.setFillColor(240, 240, 240);
                pdf.rect(tableStartX - 2, y - 6, usableWidth + 4, 8, 'F');
                pdf.setFontSize(10);
                pdf.setTextColor('#333');
                pdf.setFont('helvetica', 'bold');
                pdf.text('Parameter', colX[0], y);
                pdf.text('Current', colX[1], y);
                pdf.text('New', colX[2], y);
                y += 8;

                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor('#111');

                const params = [
                    ['D (mm)', read('currentDiameter') || '-', read('newDiameter') || '-'],
                    ['VC (m/min)', read('currentVC') || '-', read('newVC') || '-'],
                    ['Ap (mm)', read('currentAp') || '-', read('newAp') || '-'],
                    ['RPM', read('currentRPM') || '-', read('newRPM') || '-'],
                    ['F (mm/min)', read('currentFeed') || '-', read('newFeed') || '-'],
                    ['Ae (mm)', read('currentAe') || '-', read('newAe') || '-']
                ];

                params.forEach(row => {
                    if (y > 260) { pdf.addPage(); y = 18; }
                    pdf.text(String(row[0]), colX[0], y);
                    pdf.text(String(row[1]), colX[1], y);
                    pdf.text(String(row[2]), colX[2], y);
                    y += 7;
                    pdf.setDrawColor(220);
                    pdf.line(tableStartX - 2, y - 4, tableStartX - 2 + usableWidth + 4, y - 4);
                });
                y += 6;

                // Financial summary
                pdf.setFontSize(11);
                pdf.setTextColor('#00aa00');
                pdf.setFont('helvetica', 'bold');
                pdf.text('Finantsilised tulemused', marginLeft, y);
                y += 6;
                pdf.setFont('helvetica','normal');
                pdf.setFontSize(10);
                const format = v => (isNaN(v) ? String(v) : (Number(v).toFixed(0) + ' ‚Ç¨'));
                const safeNum = id => { const v = document.getElementById(id); return v ? parseFloat(v.value || 0) : 0; };
                // Use computed values from the page (if present in text elements)
                const totalSavingsEl = document.getElementById('totalSavings');
                const totalSavingsTxt = totalSavingsEl ? totalSavingsEl.textContent : '';
                pdf.setTextColor('#e0e0e0');
                pdf.text('Aastane kokkuhoid: ' + (totalSavingsTxt || '0 ‚Ç¨'), marginLeft, y);
                y += 7;

                // Insert pie chart image if available
                try {
                    const pieCanvas = document.getElementById('savingsPieChart');
                    if (pieCanvas) {
                        const imgData = pieCanvas.toDataURL('image/png');
                        const imgW = 80; const imgH = 80;
                        if (y + imgH > 285) { pdf.addPage(); y = 20; }
                        pdf.addImage(imgData, 'PNG', pageWidth - marginLeft - imgW, y - 6, imgW, imgH);
                    }
                } catch (e) {
                    console.warn('Pie chart embedding failed (possibly tainted canvas)', e);
                }

                y += 90;

                // Add uploaded machine image if present
                try {
                    const imgEl = (document.querySelector('#imageContainer img')) || null;
                    if (imgEl && imgEl.src) {
                        // scale to fit
                        const maxW = 80; const maxH = 80;
                        // If y too low, add page
                        if (y + maxH > 285) { pdf.addPage(); y = 20; }
                        pdf.addImage(imgEl.src, 'PNG', pageWidth - marginLeft - maxW, y - 6, maxW, maxH);
                        y += maxH + 6;
                    }
                } catch (e) {
                    console.warn('Embedding uploaded image failed', e);
                }

                // Add summary rows at bottom
                if (y > 250) { pdf.addPage(); y = 20; }
                pdf.setFontSize(10);
                pdf.setTextColor('#888');
                pdf.text('Kokkuv√µte saadud andmete p√µhjal', marginLeft, y);
                y += 6;

                const summaryItems = [
                    ['Hetkel - Aastane kulu', (document.getElementById('currentAnnualCost') || {}).textContent || '0 ‚Ç¨'],
                    ['Uus t√∂√∂riist - Aastane kulu', (document.getElementById('newAnnualCost') || {}).textContent || '0 ‚Ç¨'],
                    ['S√§√§st (%)', (document.getElementById('financialGain') || {}).textContent || '0%']
                ];

                summaryItems.forEach(([label, val]) => {
                    if (y > 275) { pdf.addPage(); y = 20; }
                    pdf.setTextColor('#888'); pdf.text(label + ':', marginLeft, y);
                    pdf.setTextColor('#e0e0e0'); pdf.text(String(val), marginLeft + 80, y);
                    y += 6;
                });

                // Finalize
                const arrayBuf = pdf.output('arraybuffer');
                return new Blob([arrayBuf], { type: 'application/pdf' });
            } catch (err) {
                console.error('generateStructuredPDF error', err);
                throw err;
            }
        }

        // Modify generatePDFReport to try structured PDF first and fall back to screenshot method
        async function generatePDFReport() {
            try {
                const statusEl = document.getElementById('emailStatus');
                if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Genereerin PDF (struktureeritud)...'; }
                try {
                    const blob = await generateStructuredPDF();
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    const a = document.createElement('a'); a.href = url; a.download = 'ToolBoss-report.pdf'; document.body.appendChild(a); a.click(); a.remove();
                    if (statusEl) statusEl.textContent = 'Struktureeritud PDF loodud.';
                    return;
                } catch (structuredErr) {
                    console.warn('Structured PDF failed, falling back to screenshot PDF', structuredErr);
                    if (statusEl) statusEl.textContent = 'Struktureeritud PDF eba√µnnestus, teen ekraani-pildi PDFi...';
                    // fall through to previous method
                }

                // fallback: screenshot-based PDF
                const blob = await generatePDFBlob();
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                const a = document.createElement('a'); a.href = url; a.download = 'ToolBoss-report.pdf'; document.body.appendChild(a); a.click(); a.remove();
                if (statusEl) { statusEl.textContent = 'PDF on loodud (ekraanipilt).'; }
            } catch (err) {
                console.error('generatePDFReport error', err);
                alert('PDF genereerimine eba√µnnestus: ' + (err && err.message ? err.message : String(err)));
            }
        }

        // Show email modal dialog (simple show/hide implementation)
        function showEmailDialog() {
            try { const modal = document.getElementById('emailModal'); if (!modal) return; modal.classList.add('show'); const rcpt = document.getElementById('recipientEmail'); if (rcpt) rcpt.focus(); const status = document.getElementById('emailStatus'); if (status) { status.textContent = ''; status.style.display = 'block'; } } catch (e) { console.warn('showEmailDialog error', e); }
        }

        function closeEmailDialog() {
            try { const modal = document.getElementById('emailModal'); if (!modal) return; modal.classList.remove('show'); const status = document.getElementById('emailStatus'); if (status) status.textContent = ''; } catch (e) { console.warn('closeEmailDialog error', e); }
        }

        // Close modal on backdrop click and ESC key
        (function(){
            try {
                const modal = document.getElementById('emailModal');
                if (!modal) return;
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeEmailDialog();
                });
                document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeEmailDialog(); });
            } catch (e) { console.warn('modal listeners init failed', e); }
        })();

        // sendEmail: generate PDF and POST it to server endpoint /api/send-report so server can send email with attachment
        async function sendEmail() {
            try {
                const rcpt = (document.getElementById('recipientEmail') || {}).value || '';
                const sender = (document.getElementById('senderEmail') || {}).value || '';
                const msg = (document.getElementById('emailMessage') || {}).value || '';
                const status = document.getElementById('emailStatus');

                if (!rcpt) {
                    if (status) status.textContent = 'Palun sisesta saaja e-mail.';
                    return;
                }

                if (status) status.textContent = 'Genereerin PDF...';

                // Generate PDF (structured preferred, fallback to screenshot)
                let blob = null;
                try { blob = await generateStructuredPDF(); } catch (structuredErr) {
                    console.warn('Structured PDF failed, falling back to screenshot', structuredErr);
                    blob = await generatePDFBlob();
                }

                if (!blob) throw new Error('PDF generation returned no blob');

                // Prepare form data and POST to server endpoint
                try {
                    const fd = new FormData();
                    fd.append('report', blob, 'ToolBoss-report.pdf');
                    fd.append('to', rcpt);
                    if (sender) fd.append('cc', sender);
                    fd.append('message', msg || '');
                    fd.append('subject', 'Venten ToolBoss raport');

                    const res = await fetch('/api/send-report', { method: 'POST', body: fd });
                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error('Server responded with ' + res.status + ': ' + text);
                    }
                    const json = await res.json();
                    if (json && json.success) {
                        if (status) status.textContent = 'Raport saadetud e-kirjana.';
                        closeEmailDialog();
                        return;
                    } else {
                        throw new Error('Server did not confirm send.');
                    }
                } catch (sendErr) {
                    console.warn('Server send failed, falling back to mailto/download', sendErr);
                    // fallback: open PDF in new tab and prefill mailto (user attaches file manually)
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    const subject = encodeURIComponent('Venten ToolBoss raport');
                    const bodyLines = [];
                    bodyLines.push(msg || '');
                    bodyLines.push('\n(Report generated by Venten ToolBoss. Please attach the downloaded PDF to the email.)');
                    const body = encodeURIComponent(bodyLines.join('\n'));
                    window.location.href = `mailto:${encodeURIComponent(rcpt)}?subject=${subject}&body=${body}`;
                    if (status) status.textContent = 'Serveri saatmine eba√µnnestus; genereeritud PDF on avatud, palun kinnita e-kirja saatmine oma kliendis.';
                }
            } catch (err) {
                console.error('sendEmail error', err);
                const status = document.getElementById('emailStatus'); if (status) status.textContent = 'E-kirja saatmine eba√µnnestus: ' + (err && err.message ? err.message : String(err));
            }
        }
    </script>
</div>
</body>
</html>
